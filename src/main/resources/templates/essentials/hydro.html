<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="pl">
<head>
    <th:block th:replace="~{fragments/head :: head-content(
        pageTitle='Stan Wody i Przepływy - Hydrologia IMGW | CzyZlowie',
        pageDescription='Aktualne stany wód, przepływy i zjawiska lodowe na rzekach. Dane ze stacji hydrologicznych IMGW na żywo.'
    )}"></th:block>

    <link rel="stylesheet" th:href="@{/css/essentials/hydro.css}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/hammerjs@2.0.8"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>
    <style>
        .chart-filter-btn {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #94a3b8;
            padding: 4px 12px;
            font-size: 0.85rem;
            border-radius: 6px;
            transition: all 0.2s;
        }
        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #10b981;
            box-shadow: 0 0 8px #10b981;
            animation: pulse-green 2s infinite;
        }

        @keyframes pulse-green {
            0% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7); }
            70% { box-shadow: 0 0 0 6px rgba(16, 185, 129, 0); }
            100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); }
        }

        .time-badge {
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 4px 12px;
            font-size: 0.8rem;
            color: #cbd5e1;
            backdrop-filter: blur(4px);
        }
        .chart-filter-btn:hover { background: rgba(59, 130, 246, 0.2); color: #fff; }
        .chart-filter-btn.active { background: #3b82f6; color: #fff; border-color: #3b82f6; }

        .hydro-chart-wrapper {
            background: rgba(15, 23, 42, 0.4); border: 1px solid rgba(255,255,255,0.05);
            border-radius: 12px; padding: 15px; margin-bottom: 20px; box-shadow: inset 0 0 20px rgba(0,0,0,0.2);
        }

        .stale-warning {
            background: rgba(245, 158, 11, 0.1); border: 1px dashed rgba(245, 158, 11, 0.4);
            color: #fcd34d; font-size: 0.8rem; padding: 6px 12px; border-radius: 6px; display: inline-flex; align-items: center; gap: 6px;
        }

        .sensor-time-badge {
            font-size: 0.75rem; padding: 2px 8px; border-radius: 12px; background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1); color: #94a3b8; display: inline-flex; align-items: center; gap: 4px;
        }
        .sensor-time-badge i { width: 12px; height: 12px; }
    </style>
</head>
<body class="hydro-page">

<nav th:replace="~{fragments/navbar :: navbar}"></nav>

<div class="hydro-bg-container">
    <picture>
        <source media="(max-width: 768px)" srcset="/assets/ryby/river-bg-mobile.jpg">
        <img src="/assets/ryby/river-bg.jpg" alt="Bystry nurt rzeki o poranku" class="hydro-bg-image">
    </picture>
    <div class="hydro-bg-overlay"></div>
    <div class="hydro-glow glow-blue-top"></div>
    <div class="hydro-glow glow-cyan-bottom"></div>
</div>

<main class="hydro-wrapper pb-5 position-relative z-2">
    <div class="container-xl pt-4 mt-3">

        <nav aria-label="breadcrumb" class="mb-4">
            <ol class="breadcrumb hydro-breadcrumb">
                <li class="breadcrumb-item"><a th:href="@{/}"><i data-lucide="home" class="bc-icon text-brand-green"></i> Główna</a></li>
                <li class="breadcrumb-item"><a th:href="@{/niezbednik}">Niezbędnik</a></li>
                <li class="breadcrumb-item active fw-bold text-white" aria-current="page">Stany Wód</li>
            </ol>
        </nav>

        <header class="hydro-glass-panel p-4 p-lg-5 mb-4 border-hydro-blue-subtle">
            <div class="row align-items-center justify-content-between g-4">
                <div class="col-lg-7">
                    <div class="d-flex align-items-center gap-3 mb-3">
                        <div class="hydro-icon-pulse">
                            <i data-lucide="waves" class="text-hydro-blue" style="width: 32px; height: 32px;"></i>
                        </div>
                        <h1 class="display-5 fw-black text-white mb-0 hydro-title-glow">Stany Wód</h1>
                    </div>
                    <p class="hydro-text-readable fs-5 mb-0">
                        Zaawansowana telemetria rzek ze stacji <span class="text-hydro-blue fw-bold text-glow-blue">IMGW</span>.
                    </p>
                </div>

                <div class="col-lg-5 text-lg-end">
                    <form id="hydro-geocoding-form" class="hydro-search-form" aria-label="Wyszukiwarka stacji hydrologicznych">
                        <div class="hydro-search-input-group d-flex flex-nowrap w-100">
                            <i data-lucide="map-pin" class="search-icon flex-shrink-0"></i>
                            <input type="text" id="hydro-city-input" class="search-input flex-grow-1" style="min-width: 0;"
                                   th:value="${lokalizacja}" placeholder="Wpisz miasto lub rzekę..." required>
                            <button type="submit" id="hydro-search-btn" class="hydro-search-btn flex-shrink-0">
                                <span class="d-none d-sm-inline">Szukaj</span> <i data-lucide="search" style="width: 18px;"></i>
                            </button>
                        </div>
                    </form>
                    <div class="mt-2 pe-3 text-white opacity-50 fs-8 text-end">
                        <i data-lucide="crosshair" style="width: 12px;"></i>
                        Dystans do stacji: <span th:text="${dashboard.distanceKm}">0.0</span> km
                    </div>
                </div>
            </div>
        </header>

        <div th:if="${!dashboard.hasWaterLevelData && !dashboard.hasDischargeData}" class="alert alert-warning border-warning bg-dark text-warning">
            <i data-lucide="alert-triangle" class="me-2"></i>
            Stacja <strong>[[${dashboard.stationName}]] (ID: [[${dashboard.stationId}]])</strong> w lokalizacji <strong>[[${dashboard.locationName}]]</strong> obecnie nie zwraca żadnych danych pomiarowych.
        </div>

        <div class="row g-4 mb-4" th:if="${dashboard.hasWaterLevelData || dashboard.hasDischargeData}">
            <div class="col-lg-8">
                <div class="hydro-glass-panel p-0 mb-4 overflow-hidden position-relative">
                    <div class="row g-0 position-relative z-1">

                        <div class="col-md-5 p-4 p-md-5 text-center text-md-start hydro-border-end d-flex flex-column justify-content-center position-relative">
                            <div class="d-flex justify-content-between align-items-center mb-4">
                                <span class="text-uppercase fw-bold fs-7 hydro-text-readable" style="letter-spacing: 1px;">Status stacji</span>
                                <span class="hydro-location-badge text-truncate" style="max-width: 60%;" th:title="${dashboard.stationName}" th:text="${dashboard.stationName}">Stacja</span>
                            </div>

                            <div th:if="${dashboard.currentReading.waterLevel != null}">
                                <h2 class="display-1 fw-black text-white mb-0 lh-1">
                                    <span th:text="${dashboard.currentReading.waterLevel}">0</span><span class="fs-4 text-white opacity-50 ms-1">cm</span>
                                </h2>

                                <div class="sensor-time-badge mt-2 mb-4">
                                    <i data-lucide="clock"></i> Zaktualizowano: <span th:text="${dashboard.lastWaterLevelTime}"></span>
                                </div>

                                <div th:with="trendName=${dashboard.waterLevelTrend.name()}" class="hydro-alert"
                                     th:classappend="${trendName == 'RISING' ? 'text-success border-success bg-success bg-opacity-10' :
                             (trendName == 'FALLING' ? 'text-danger border-danger bg-danger bg-opacity-10' : 'text-info border-info bg-info bg-opacity-10')}">
                                    <i th:attr="data-lucide=${trendName == 'RISING' ? 'trending-up' : (trendName == 'FALLING' ? 'trending-down' : 'minus')}" style="width: 16px;"></i>
                                    <span th:text="${trendName == 'RISING' ? 'Woda przybiera (korzystne)' : (trendName == 'FALLING' ? 'Woda opada' : 'Poziom stabilny')}">Trend</span>
                                </div>
                            </div>

                            <div th:unless="${dashboard.currentReading.waterLevel != null}">
                                <h2 class="fs-3 fw-bold text-white opacity-50 mb-0">Brak Pomiaru</h2>
                            </div>
                        </div>

                        <div class="col-md-7 p-4 p-md-5 hydro-condition-bg d-flex flex-column justify-content-center">
                            <div class="row w-100 g-4 text-start">

                                <div class="col-12 d-flex align-items-center gap-3 mb-md-2 pb-4 border-bottom border-dark-subtle border-opacity-25">
                                    <div class="flex-shrink-0 p-3 bg-dark bg-opacity-50 rounded-circle border border-dark-subtle">
                                        <i data-lucide="droplets" class="text-hydro-blue" style="width: 28px; height: 28px;"></i>
                                    </div>
                                    <div class="w-100">
                                        <div class="d-flex justify-content-between align-items-center mb-1">
                                            <span class="hydro-text-readable fs-8 text-uppercase fw-bold">Przepływ</span>
                                            <span class="sensor-time-badge" th:if="${dashboard.currentReading.discharge != null}">
                                                <i data-lucide="clock"></i> [[${dashboard.lastDischargeTime}]]
                                            </span>
                                        </div>
                                        <div th:if="${dashboard.currentReading.discharge != null}">
                                            <span class="fs-2 fw-bold text-white"><span th:text="${dashboard.currentReading.discharge}"></span> <span class="fs-6 opacity-50">m³/s</span></span>
                                        </div>
                                        <div th:unless="${dashboard.currentReading.discharge != null}">
                                            <span class="fs-7 fw-bold text-white opacity-50 badge bg-dark border border-secondary mt-1">Brak Czujnika</span>
                                        </div>
                                    </div>
                                </div>

                                <div class="col-6 d-flex flex-column gap-1">
                                    <span class="d-block hydro-text-readable fs-8 text-uppercase fw-bold mb-1">Temp. Wody</span>
                                    <div class="d-flex align-items-center gap-2">
                                        <i data-lucide="thermometer" class="text-brand-green opacity-75" style="width: 20px;"></i>
                                        <div th:if="${dashboard.currentReading.waterTemperature != null}">
                                            <span class="fs-4 fw-bold text-white"><span th:text="${dashboard.currentReading.waterTemperature}"></span>°C</span>
                                        </div>
                                        <div th:unless="${dashboard.currentReading.waterTemperature != null}">
                                            <span class="fs-7 fw-bold text-white opacity-50 badge bg-dark border border-secondary">Brak</span>
                                        </div>
                                    </div>
                                    <span class="sensor-time-badge mt-1 align-self-start" th:if="${dashboard.currentReading.waterTemperature != null}">
                                        <i data-lucide="clock"></i> [[${dashboard.lastTemperatureTime}]]
                                    </span>
                                </div>

                                <div class="col-6 d-flex flex-column gap-1">
                                    <span class="d-block hydro-text-readable fs-8 text-uppercase fw-bold mb-1">Zjawisko Lodowe</span>
                                    <div class="d-flex align-items-center gap-2 mt-1">
                                        <i data-lucide="snowflake" class="text-info opacity-75 flex-shrink-0" style="width: 20px;"></i>
                                        <span class="fs-6 fs-md-5 fw-bold text-white text-break lh-1" th:text="${dashboard.currentReading.icePhenomenon != null && dashboard.currentReading.icePhenomenon > 0 ? 'WYSTĘPUJE' : 'BRAK'}">BRAK</span>
                                    </div>
                                </div>

                            </div>
                        </div>
                    </div>
                </div>

                <div class="hydro-glass-panel p-2" th:if="${dashboard.hasWaterLevelData || dashboard.hasDischargeData || dashboard.hasTemperatureData}">
                    <div class="d-flex gap-2 flex-wrap justify-content-end mb-3 me-1" id="chart-controls">
                        <button class="btn chart-filter-btn text-warning" id="reset-zoom-btn" style="display: none;" title="Resetuj przybliżenie">
                            <i data-lucide="zoom-out" style="width: 16px;"></i>
                        </button>
                        <button class="btn chart-filter-btn" data-days="1">24H</button>
                        <button class="btn chart-filter-btn" data-days="3">3 DNI</button>
                        <button class="btn chart-filter-btn active" data-days="5">5 DNI</button>
                    </div>

                    <div th:if="${dashboard.hasWaterLevelData}" class="hydro-chart-wrapper">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h4 class="fs-6 text-white opacity-75 mb-0"><i data-lucide="waves" style="width:16px;" class="me-1"></i> Stan Wody (cm)</h4>
                            <div th:if="${dashboard.waterLevelStale}" class="stale-warning" title="IMGW przestało wysyłać nowe wartości">
                                <i data-lucide="siren" style="width:14px;"></i> Czujnik zawieszony
                            </div>
                        </div>
                        <div class="chart-container" style="position: relative; height: 200px; width: 100%;">
                            <canvas id="waterLevelChart"></canvas>
                        </div>
                    </div>

                    <div th:if="${dashboard.hasDischargeData}" class="hydro-chart-wrapper">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h4 class="fs-6 text-white opacity-75 mb-0"><i data-lucide="droplets" style="width:16px;" class="me-1"></i> Przepływ (m³/s)</h4>
                            <div th:if="${dashboard.dischargeStale}" class="stale-warning" title="IMGW przestało wysyłać nowe wartości">
                                <i data-lucide="siren" style="width:14px;"></i> Czujnik zawieszony
                            </div>
                        </div>
                        <div class="chart-container" style="position: relative; height: 200px; width: 100%;">
                            <canvas id="dischargeChart"></canvas>
                        </div>
                    </div>

                    <div th:if="${dashboard.hasTemperatureData}" class="hydro-chart-wrapper mb-0">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h4 class="fs-6 text-white opacity-75 mb-0"><i data-lucide="thermometer" style="width:16px;" class="me-1"></i> Temperatura Wody (°C)</h4>
                            <div th:if="${dashboard.temperatureStale}" class="stale-warning">
                                <i data-lucide="siren" style="width:14px;"></i> Czujnik zawieszony
                            </div>
                        </div>
                        <div class="chart-container" style="position: relative; height: 200px; width: 100%;">
                            <canvas id="tempChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <aside class="col-lg-4">
                <article class="hydro-glass-panel p-4 h-100 d-flex flex-column border-top border-4 border-brand-green">
                    <div class="mb-4 d-flex align-items-center gap-2 text-brand-green border-bottom border-dark-subtle pb-3">
                        <i data-lucide="brain-circuit" style="width: 24px; height: 24px;"></i>
                        <h2 class="fs-5 text-white fw-bold mb-0">Ekspercka Analiza</h2>
                    </div>

                    <div class="hydro-knowledge-item mb-4">
                        <h3 class="fs-6 text-white fw-bold mb-2 d-flex align-items-center gap-2"><i data-lucide="activity" style="width: 16px;"></i> Aktywność a Trend</h3>
                        <p class="hydro-text-readable fs-7 lh-lg mb-0 text-justify" th:switch="${dashboard.waterLevelTrend.name()}">
                            <span th:case="'RISING'">
                                <strong class="text-success">Rosnący poziom wody to sygnał do ataku.</strong> Nurt podmywa brzegi, uwalniając wypłukiwane robaki i larwy. Białoryb (np. klenie, jazie) podchodzi bardzo blisko brzegu na żer. Drapieżniki podążają ich śladem. Idealny czas na łowienie w płytkich rynnach rzecznych przy zalanych trawach.
                            </span>
                            <span th:case="'FALLING'">
                                <strong class="text-danger">Spadająca woda wymaga ostrożności.</strong> Ryby wpadają w apatię i instynktownie cofają się z płycizn do głębszego koryta i warkoczy za główkami, obawiając się odcięcia od nurtu. Zastosuj dłuższe przypony i delikatniejsze zestawy. Szukaj ryb na przegłębieniach.
                            </span>
                            <span th:case="*">
                                <strong class="text-info">Stabilna woda promuje systematyczność.</strong> Ryby ustabilizowały swoje trasy patrolowe. To idealne warunki do wielodniowego, regularnego nęcenia grubym ziarnem (kukurydza, groch), co skupi stado w jednym, wytypowanym przez Ciebie miejscu.
                            </span>
                        </p>
                    </div>

                    <div class="hydro-knowledge-item mb-4" th:if="${dashboard.currentReading.waterTemperature != null}">
                        <h3 class="fs-6 text-white fw-bold mb-2 d-flex align-items-center gap-2"><i data-lucide="thermometer" style="width: 16px;"></i> Metabolizm (Temp: [[${dashboard.currentReading.waterTemperature}]]°C)</h3>
                        <p class="hydro-text-readable fs-7 lh-lg mb-0 text-justify">
                            <span th:if="${dashboard.currentReading.waterTemperature.doubleValue() < 5.0}">Woda zimowa. Metabolizm ryb jest maksymalnie spowolniony. Używaj najcieńszych żyłek, małych haczyków i żywych przynęt (pinka, ochotka). Brania będą ledwie widoczne. Szukaj najgłębszych i najspokojniejszych klatek.</span>
                            <span th:if="${dashboard.currentReading.waterTemperature.doubleValue() >= 5.0 && dashboard.currentReading.waterTemperature.doubleValue() <= 12.0}">Wiosenne przebudzenie lub jesienne chłody. Drapieżniki (szczupak, sandacz) stają się bardzo agresywne. Białoryb zaczyna intensywnie poszukiwać pokarmu białkowego przed/po zimie. Czerwony robak i grube pellety mięsne to strzał w dziesiątkę.</span>
                            <span th:if="${dashboard.currentReading.waterTemperature.doubleValue() > 12.0}">Ciepła woda. Ryby żerują niezwykle aktywnie na całej szerokości rzeki. To idealny moment na intensywne nęcenie słodkimi zanętami owocowymi, kukurydzą i method feederem. Uważaj na ewentualne przyduchy w płytkich starorzeczach!</span>
                        </p>
                    </div>

                    <div class="hydro-knowledge-item mb-4 pb-4 border-bottom border-dark-subtle" th:if="${dashboard.currentReading.discharge != null}">
                        <h3 class="fs-6 text-white fw-bold mb-2 d-flex align-items-center gap-2"><i data-lucide="anchor" style="width: 16px;"></i> Dobór Sprzętu (Nurt)</h3>
                        <p class="hydro-text-readable fs-7 lh-lg mb-0 text-justify">
                            Przy przepływie <strong>[[${dashboard.currentReading.discharge}]] m³/s</strong>,
                            <span th:if="${dashboard.currentReading.discharge.doubleValue() > 25.0}">siła uciągu jest potężna. Skup się na łowieniu z koszyczkami z wąsami (100g+) w strefach brzegowych i klatkach między ostrogami, gdzie nurt zwalnia i powstają tzw. warkocze. Używaj długich wędzisk typu Heavy Feeder (3.90m+).</span>
                            <span th:if="${dashboard.currentReading.discharge.doubleValue() <= 25.0 && dashboard.currentReading.discharge.doubleValue() > 10.0}">nurt jest umiarkowany. Koszyczki rzeczne o wadze 50-80g spokojnie utrzymają dno. Klasyczny feeder sprawdzi się tu idealnie na skraju głównego nurtu.</span>
                            <span th:if="${dashboard.currentReading.discharge.doubleValue() <= 10.0}">uciąg jest znikomy. To świetne warunki do finezyjnego łowienia (lekki feeder 30g, spławik na przepływankę). Możesz celować w samo koryto rzeki.</span>
                        </p>
                    </div>

                    <div class="mt-auto bg-dark bg-opacity-80 p-3 rounded-3 border border-brand-green position-relative overflow-hidden text-center">
                        <span class="d-block hydro-text-readable fs-8 text-uppercase fw-bold mb-1">Ocena Warunków Żerowych</span>

                        <div th:with="trendName=${dashboard.waterLevelTrend.name()}, temp=${dashboard.currentReading.waterTemperature != null ? dashboard.currentReading.waterTemperature.doubleValue() : 10.0}"
                             class="d-flex align-items-center justify-content-center mt-2 min-h-40">

                            <span class="fs-4 fs-xl-3 fw-black text-success text-glow-green text-break lh-1"
                                  th:if="${trendName == 'RISING' && temp > 10.0}">IDEALNE (10/10)</span>

                            <span class="fs-4 fs-xl-3 fw-black text-success text-glow-green text-break lh-1"
                                  th:if="${trendName == 'RISING' && temp <= 10.0}">B. DOBRE (8/10)</span>

                            <span class="fs-4 fs-xl-3 fw-black text-info text-glow-blue text-break lh-1"
                                  th:if="${trendName == 'STABLE'}">DOBRE (6/10)</span>

                            <span class="fs-4 fs-xl-3 fw-black text-warning text-break lh-1"
                                  th:if="${trendName == 'FALLING'}">TRUDNE (4/10)</span>
                        </div>
                    </div>
                </article>
            </aside>
        </div>
    </div>
</main>

<footer th:replace="~{fragments/footer :: footer}"></footer>

<script th:inline="javascript">
    document.addEventListener('DOMContentLoaded', () => {
        lucide.createIcons();

        const allLabels = /*[[${dashboard.chartLabels}]]*/ [];
        const allTimestamps = /*[[${dashboard.chartTimestampsIso}]]*/ [];
        const allWaterLevels = /*[[${dashboard.chartWaterLevels}]]*/ [];
        const allDischarges = /*[[${dashboard.chartDischarges}]]*/ [];
        const allTemps = /*[[${dashboard.chartWaterTemperatures}]]*/ [];

        const hasWater = /*[[${dashboard.hasWaterLevelData}]]*/ false;
        const hasDischarge = /*[[${dashboard.hasDischargeData}]]*/ false;
        const hasTemp = /*[[${dashboard.hasTemperatureData}]]*/ false;

        if (!allLabels || allLabels.length === 0) return;

        let wlChartInst, disChartInst, tempChartInst;

        function createChart(ctxId, labels, data, label, colorKey, chartInst, unit) {
            const canvas = document.getElementById(ctxId);
            if (!canvas) return chartInst;

            const ctx = canvas.getContext('2d');
            let gradient = ctx.createLinearGradient(0, 0, 0, 180);
            gradient.addColorStop(0, colorKey);
            gradient.addColorStop(1, 'rgba(0, 0, 0, 0)');

            if (chartInst) { chartInst.destroy(); }

            return new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: label,
                        data: data,
                        borderColor: colorKey,
                        backgroundColor: gradient,
                        borderWidth: 2,
                        pointBackgroundColor: '#0f172a',
                        pointBorderColor: colorKey,
                        pointRadius: 1,
                        pointHoverRadius: 6,
                        fill: true,
                        tension: 0.1,
                        spanGaps: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(15, 23, 42, 0.95)',
                            padding: 12, titleColor: '#94a3b8',
                            borderColor: 'rgba(255, 255, 255, 0.1)', borderWidth: 1,
                            callbacks: { label: (ctx) => ` ${label}: ${ctx.parsed.y} ${unit}` }
                        },
                        zoom: {
                            pan: {
                                enabled: true,
                                mode: 'x',
                                modifierKey: 'ctrl',
                            },
                            zoom: {
                                wheel: { enabled: true },
                                pinch: { enabled: true },
                                mode: 'x',
                                onZoomStart: function() {
                                    const rBtn = document.getElementById('reset-zoom-btn');
                                    if(rBtn) rBtn.style.display = 'inline-flex';
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            suggestedMin: Math.min(...data.filter(v => v != null)) * 0.98,
                            suggestedMax: Math.max(...data.filter(v => v != null)) * 1.02,
                            grid: { color: 'rgba(255, 255, 255, 0.05)' },
                            ticks: { color: '#94a3b8', font: { size: 10 } }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { color: '#94a3b8', autoSkip: true, maxTicksLimit: 8, font: { size: 10 } }
                        }
                    }
                }
            });
        }

        function renderCharts(daysCutoff) {
            const cutoffDate = new Date();
            cutoffDate.setDate(cutoffDate.getDate() - daysCutoff);

            let fLabels = [], fWater = [], fDischarge = [], fTemp = [];

            for (let i = 0; i < allTimestamps.length; i++) {
                const rowDate = new Date(allTimestamps[i]);
                if (rowDate >= cutoffDate) {
                    fLabels.push(allLabels[i]);
                    fWater.push(allWaterLevels[i]);
                    fDischarge.push(allDischarges[i]);
                    fTemp.push(allTemps[i]);
                }
            }

            if (hasWater) wlChartInst = createChart('waterLevelChart', fLabels, fWater, 'Stan', '#3b82f6', wlChartInst, 'cm');
            if (hasDischarge) disChartInst = createChart('dischargeChart', fLabels, fDischarge, 'Przepływ', '#10b981', disChartInst, 'm³/s');
            if (hasTemp) tempChartInst = createChart('tempChart', fLabels, fTemp, 'Temp', '#f59e0b', tempChartInst, '°C');

            const resetBtn = document.getElementById('reset-zoom-btn');
            if (resetBtn) resetBtn.style.display = 'none';
        }

        renderCharts(5);

        document.querySelectorAll('.chart-filter-btn:not(#reset-zoom-btn)').forEach(btn => {
            btn.addEventListener('click', (e) => {
                document.querySelectorAll('.chart-filter-btn:not(#reset-zoom-btn)').forEach(b => b.classList.remove('active'));
                e.target.classList.add('active');
                renderCharts(parseInt(e.target.getAttribute('data-days')));
            });
        });

        const resetZoomBtn = document.getElementById('reset-zoom-btn');
        if (resetZoomBtn) {
            resetZoomBtn.addEventListener('click', () => {
                if (wlChartInst) wlChartInst.resetZoom();
                if (disChartInst) disChartInst.resetZoom();
                if (tempChartInst) tempChartInst.resetZoom();
                resetZoomBtn.style.display = 'none';
            });
        }
    });

    const searchForm = document.getElementById('hydro-geocoding-form');
    if (searchForm) {
        searchForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            const inputVal = document.getElementById('hydro-city-input').value;
            const btn = document.getElementById('hydro-search-btn');
            const originalContent = btn.innerHTML;

            btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
            btn.style.opacity = '0.7'; btn.disabled = true;

            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(inputVal)}&countrycodes=pl&limit=1`);
                const data = await response.json();
                if (data && data.length > 0) {
                    const cleanName = (data[0].name || inputVal).split(',')[0].trim();
                    window.location.href = `/hydro?lat=${data[0].lat}&lon=${data[0].lon}&miasto=${cleanName}`;
                } else {
                    alert("Nie znaleziono lokalizacji."); resetBtn();
                }
            } catch (error) { alert("Błąd połączenia."); resetBtn(); }

            function resetBtn() { btn.innerHTML = originalContent; btn.style.opacity = '1'; btn.disabled = false; }
        });
    }
</script>
</body>
</html>