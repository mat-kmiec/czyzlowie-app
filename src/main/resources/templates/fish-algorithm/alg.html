<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="pl">
<head>
    <th:block th:replace="~{fragments/head :: head-content(
        pageTitle='Kalibrator Algorytmu | Prognoza Bra | CzyZlowie',
        pageDescription='Skonfiguruj zaawansowany algorytm wdkarski. Wybierz lokalizacj, gatunki ryb i filtry telemetryczne IMGW.'
    )}"></th:block>

    <style>
        :root {
            --brand-green: #2ecc71;
            --brand-green-glow: rgba(46, 204, 113, 0.25);
            --predator-red: #ef4444;
            --predator-red-glow: rgba(239, 68, 68, 0.25);
            --ignore-orange: #f59e0b;
            --ignore-orange-glow: rgba(245, 158, 11, 0.2);
            --bg-dark-base: #0f172a;
            --glass-bg: rgba(15, 23, 42, 0.75);
            --glass-border: rgba(255, 255, 255, 0.08);
            --text-main: #f8fafc;
            --text-secondary: #94a3b8;
        }

        .algo-page { background-color: var(--bg-dark-base); min-height: 100vh; color: var(--text-main); }
        .algo-bg-container { position: fixed; top: 0; left: 0; width: 100%; height: 100vh; z-index: 0; overflow: hidden; }
        .algo-bg-image { width: 100%; height: 100%; object-fit: cover; opacity: 0.35; filter: blur(4px); }
        .algo-bg-overlay { position: absolute; inset: 0; background: linear-gradient(180deg, rgba(15,23,42,0.8) 0%, rgba(15,23,42,0.98) 100%); }
        .algo-glow { position: absolute; border-radius: 50%; filter: blur(120px); opacity: 0.4; pointer-events: none; }
        .glow-top-left { top: -10%; left: -10%; width: 40vw; height: 40vw; background: rgba(46, 204, 113, 0.2); }
        .glow-bottom-right { bottom: -10%; right: -10%; width: 50vw; height: 50vw; background: rgba(239, 68, 68, 0.1); }

        .algo-glass-panel {
            background: var(--glass-bg); backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px);
            border: 1px solid var(--glass-border); border-radius: 16px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
            transition: all 0.3s ease;
        }
        .algo-glass-panel:hover { border-color: rgba(255, 255, 255, 0.15); box-shadow: 0 8px 40px rgba(0, 0, 0, 0.7); }

        .section-header {
            font-size: 0.95rem; font-weight: 800; letter-spacing: 1.5px; text-transform: uppercase;
            color: #fff; margin-bottom: 1.5rem; display: flex; align-items: center; gap: 0.75rem;
            border-bottom: 1px solid var(--glass-border); padding-bottom: 1rem;
        }

        .algo-input {
            background: rgba(0, 0, 0, 0.5); border: 1px solid var(--glass-border); color: #fff;
            border-radius: 10px; padding: 0.9rem 1rem 0.9rem 2.8rem; font-size: 1rem; width: 100%; transition: all 0.3s;
        }
        .algo-input:focus { outline: none; border-color: var(--brand-green); box-shadow: 0 0 0 3px var(--brand-green-glow); background: rgba(0, 0, 0, 0.7); }
        .algo-input option { background: #0f172a; color: #fff; }
        .input-icon { position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: #64748b; pointer-events: none; transition: 0.3s; }
        .algo-input:focus ~ .input-icon { color: var(--brand-green); }

        .btn-gps {
            background: rgba(46, 204, 113, 0.05); border: 1px dashed rgba(46, 204, 113, 0.5); color: var(--brand-green);
            border-radius: 10px; padding: 0.85rem; font-weight: 700; transition: all 0.3s;
        }
        .btn-gps:hover { background: rgba(46, 204, 113, 0.15); border-style: solid; box-shadow: 0 0 15px var(--brand-green-glow); }

        .fish-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(95px, 1fr)); gap: 0.75rem; }
        @media (min-width: 576px) { .fish-grid { grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)); } }

        .fish-card {
            cursor: pointer; position: relative; background: rgba(0, 0, 0, 0.4); border: 1px solid var(--glass-border);
            border-radius: 12px; padding: 1rem 0.5rem; text-align: center; transition: all 0.2s ease-in-out; user-select: none;
            overflow: hidden; height: 100%; display: flex; flex-direction: column; justify-content: center;
        }
        .fish-card input[type="checkbox"] { display: none; }
        .fish-card i { color: #64748b; transition: 0.3s; margin-bottom: 0.5rem; }
        .fish-card span { color: var(--text-secondary); font-size: 0.8rem; font-weight: 700; transition: 0.3s; line-height: 1.1; }

        .fish-card:hover { background: rgba(255,255,255,0.05); border-color: rgba(255,255,255,0.2); transform: translateY(-2px); }

        .card-predator:has(input:checked) { border-color: var(--predator-red); background: rgba(239, 68, 68, 0.08); box-shadow: inset 0 0 20px var(--predator-red-glow); }
        .card-predator input:checked + div i { color: var(--predator-red); filter: drop-shadow(0 0 8px var(--predator-red)); transform: scale(1.1); }
        .card-predator input:checked + div span { color: #fff; }

        .card-whitefish:has(input:checked) { border-color: var(--brand-green); background: rgba(46, 204, 113, 0.08); box-shadow: inset 0 0 20px var(--brand-green-glow); }
        .card-whitefish input:checked + div i { color: var(--brand-green); filter: drop-shadow(0 0 8px var(--brand-green)); transform: scale(1.1); }
        .card-whitefish input:checked + div span { color: #fff; }

        .settings-grid { display: grid; grid-template-columns: 1fr; gap: 1rem; }
        @media (min-width: 768px) { .settings-grid { grid-template-columns: repeat(2, 1fr); } }

        .algo-switch-wrapper {
            display: flex; align-items: flex-start; gap: 0.8rem; padding: 1rem;
            background: rgba(0,0,0,0.25); border: 1px solid var(--glass-border); border-radius: 10px; transition: 0.3s; height: 100%;
        }
        .algo-switch-wrapper:hover { background: rgba(0,0,0,0.4); border-color: rgba(255, 255, 255, 0.15); }

        .algo-switch {
            width: 3rem; height: 1.5rem; background-color: rgba(255,255,255,0.1); border: none; cursor: pointer; flex-shrink: 0; margin-top: 0.1rem;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.5); border-radius: 20px;
        }

        .switch-module:checked { background-color: var(--brand-green); box-shadow: 0 0 12px var(--brand-green-glow); }
        .switch-ignore:checked { background-color: var(--ignore-orange); box-shadow: 0 0 12px var(--ignore-orange-glow); }

        .switch-title { color: #fff; font-weight: 700; font-size: 0.9rem; margin-bottom: 0.2rem; display: flex; align-items: center; gap: 6px; }
        .switch-title i { width: 16px; height: 16px; color: var(--text-secondary); }
        .switch-desc { color: #64748b; font-size: 0.75rem; line-height: 1.4; }

        .btn-launch {
            background: linear-gradient(135deg, var(--brand-green), #219653); color: #000; font-weight: 900; font-size: 1.1rem;
            letter-spacing: 1px; text-transform: uppercase; border: none; border-radius: 12px; padding: 1.25rem; width: 100%;
            box-shadow: 0 0 25px var(--brand-green-glow); transition: all 0.3s; position: relative; overflow: hidden;
            display: flex; align-items: center; justify-content: center; gap: 0.75rem;
        }
        .btn-launch:hover { transform: translateY(-3px); box-shadow: 0 10px 30px rgba(46, 204, 113, 0.5); background: #27ae60; color: #fff; }

        .algo-range { -webkit-appearance: none; width: 100%; height: 6px; background: rgba(0,0,0,0.5); border: 1px solid var(--glass-border); border-radius: 3px; outline: none; }
        .algo-range::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 22px; height: 22px; background: var(--brand-green); cursor: pointer; border-radius: 50%; box-shadow: 0 0 10px var(--brand-green); }

        #fishing-loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(11, 17, 32, 0.98); backdrop-filter: blur(15px);
            z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center;
            opacity: 0; pointer-events: none; transition: opacity 0.4s;
        }
        #fishing-loader.active { opacity: 1; pointer-events: all; }

        .echo-screen {
            position: relative; width: 260px; height: 260px; border-radius: 50%;
            border: 2px solid rgba(46, 204, 113, 0.3); background: radial-gradient(circle, #0f172a 0%, #020617 100%);
            box-shadow: 0 0 40px rgba(46, 204, 113, 0.1) inset; margin-bottom: 2rem; overflow: hidden;
        }
        @media (min-width: 576px) { .echo-screen { width: 300px; height: 300px; } }

        .water-surface { position: absolute; top: 30%; left: 0; width: 100%; height: 2px; background: rgba(56, 189, 248, 0.3); }
        .loader-boat { position: absolute; top: 18%; left: 50%; transform: translateX(-50%); color: #fff; animation: bobbing 3s ease-in-out infinite; z-index: 2; }
        .sonar-wave { position: absolute; top: 30%; left: 50%; transform: translateX(-50%); border-bottom: 2px solid var(--brand-green); border-radius: 50%; opacity: 0; animation: pingDown 2.5s infinite linear; }
        .sonar-wave:nth-child(2) { animation-delay: 0.8s; }
        .sonar-wave:nth-child(3) { animation-delay: 1.6s; }

        .loader-fish { position: absolute; color: #334155; opacity: 0; transition: color 0.3s; }
        .loader-fish.active { color: var(--brand-green); filter: drop-shadow(0 0 8px var(--brand-green)); }
        .f1 { top: 50%; left: -20px; animation: swimRight 6s infinite linear 1s; }
        .f2 { top: 75%; right: -20px; transform: scaleX(-1); animation: swimLeft 7s infinite linear 2.5s; }
        .f3 { top: 60%; left: -20px; animation: swimRight 5s infinite linear 4s; }

        .progress-container { width: 90%; max-width: 320px; margin-top: 1rem; position: relative; }
        .progress-track { width: 100%; height: 4px; background: rgba(255,255,255,0.1); border-radius: 2px; overflow: hidden; }
        .progress-bar { width: 0%; height: 100%; background: var(--brand-green); box-shadow: 0 0 10px var(--brand-green); transition: width 0.3s linear; }
        .progress-hook { position: absolute; top: -14px; left: 0%; color: var(--text-main); transition: left 0.3s linear; }

        @keyframes bobbing { 0%, 100% { transform: translate(-50%, 0) rotate(-3deg); } 50% { transform: translate(-50%, 5px) rotate(3deg); } }
        @keyframes pingDown { 0% { width: 0; height: 0; opacity: 1; } 100% { width: 280px; height: 220px; opacity: 0; top: 50%; } }
        @keyframes swimRight { 0% { left: -30px; opacity: 0; } 20% { opacity: 1; } 80% { opacity: 1; } 100% { left: 320px; opacity: 0; } }
        @keyframes swimLeft { 0% { right: -30px; opacity: 0; } 20% { opacity: 1; } 80% { opacity: 1; } 100% { right: 320px; opacity: 0; } }
    </style>
</head>
<body class="algo-page">

<nav th:replace="~{fragments/navbar :: navbar}"></nav>

<div class="algo-bg-container" aria-hidden="true">
    <picture>
        <img src="/assets/drapiezniki.jpg" alt="Woda i rodowisko wdkarskie" class="algo-bg-image" loading="eager">
    </picture>
    <div class="algo-bg-overlay"></div>
    <div class="algo-glow glow-top-left"></div>
    <div class="algo-glow glow-bottom-right"></div>
</div>

<div id="fishing-loader">
    <div class="echo-screen">
        <div class="water-surface"></div>
        <div class="loader-boat"><i data-lucide="ship" style="width: 40px; height: 40px;"></i></div>
        <div class="sonar-wave"></div><div class="sonar-wave"></div><div class="sonar-wave"></div>
        <i data-lucide="fish" class="loader-fish f1" id="lf1" style="width: 24px;"></i>
        <i data-lucide="fish" class="loader-fish f2" id="lf2" style="width: 32px;"></i>
        <i data-lucide="fish" class="loader-fish f3" id="lf3" style="width: 20px;"></i>
    </div>

    <h2 id="loading-title" class="fw-black text-white mb-2 text-center text-uppercase" style="letter-spacing: 2px; text-shadow: 0 0 10px var(--brand-green);">Echosonda AI Skanuje</h2>
    <div id="loading-desc" class="text-muted fs-7 font-monospace mb-4 text-center px-3">Analiza warunk贸w batymetrycznych...</div>

    <div class="progress-container">
        <i data-lucide="anchor" class="progress-hook" id="loading-hook" style="width: 16px;"></i>
        <div class="progress-track"><div class="progress-bar" id="loading-bar"></div></div>
    </div>
</div>

<main class="container-xl position-relative z-2 pt-4 mt-3 pb-5">

    <header class="algo-glass-panel p-3 p-md-4 p-lg-5 mb-4">
        <div class="row align-items-center g-4">
            <div class="col-lg-8">
                <div class="d-flex align-items-center gap-3 mb-2">
                    <div style="background: rgba(46, 204, 113, 0.1); padding: 10px; border-radius: 10px; border: 1px solid var(--brand-green);">
                        <i data-lucide="activity" class="text-brand-green" style="width: 28px; height: 28px;"></i>
                    </div>
                    <h1 class="display-6 fw-black text-white mb-0" style="text-shadow: 0 0 15px var(--brand-green-glow);">
                        Kalibrator Algorytmu
                    </h1>
                </div>
                <p class="fs-6 mb-0 ps-1" style="color: var(--text-secondary); line-height: 1.6;">
                    Skonfiguruj parametry owiska. Nasz silnik przeanalizuje odczyty IMGW, modele Open-Meteo i dopasuje wyniki do preferencji wybranych gatunk贸w ryb.
                </p>
            </div>
            <div class="col-lg-4 text-lg-end d-none d-lg-block">
                <div class="d-inline-flex align-items-center gap-2 px-3 py-2 rounded-3" style="background: rgba(0,0,0,0.4); border: 1px solid var(--glass-border);">
                    <div class="spinner-grow spinner-grow-sm text-brand-green" role="status"></div>
                    <span class="fs-7 fw-bold text-white text-uppercase" style="letter-spacing: 1px;">Telemetria Online</span>
                </div>
            </div>
        </div>
    </header>

    <form th:action="@{/prognoza/wynik}" method="GET" id="algoForm">
        <div class="row g-4">

            <div class="col-xl-4 d-flex flex-column gap-4">
                <div class="algo-glass-panel p-3 p-md-4">
                    <div class="section-header"><i data-lucide="map-pin" class="text-brand-green"></i> 1. Lokalizacja owiska</div>
                    <div class="mb-4 position-relative">
                        <input type="text" name="location" id="locationInput" class="algo-input" placeholder="Wpisz nazw wody lub miasto..." required>
                        <i data-lucide="search" class="input-icon" style="width: 18px;"></i>
                    </div>
                    <button type="button" id="btn-locate" class="btn btn-gps w-100 d-flex align-items-center justify-content-center gap-2">
                        <i data-lucide="satellite" style="width: 18px;"></i> Namierz pozycj GPS
                    </button>
                    <input type="hidden" name="lat" id="latInput"><input type="hidden" name="lon" id="lonInput">
                </div>

                <div class="algo-glass-panel p-3 p-md-4">
                    <div class="section-header"><i data-lucide="waves" class="text-brand-green"></i> 2. Topografia Wody</div>
                    <div class="mb-4 position-relative">
                        <label class="text-white fs-8 text-uppercase fw-bold mb-2 d-block">Typ Akwenu</label>
                        <i data-lucide="droplets" class="input-icon" style="width: 16px; top: 72%;"></i>
                        <select name="waterType" class="algo-input" style="padding-left: 2.8rem;">
                            <option value="ALL">Mieszany / Nie wiem</option>
                            <option value="LAKE">Woda Stojca (Jeziora, Stawy, PZW)</option>
                            <option value="RIVER">Woda Pynca (Rzeki, Kanay)</option>
                        </select>
                    </div>
                    <div class="mb-4 position-relative">
                        <label class="text-white fs-8 text-uppercase fw-bold mb-2 d-block">Struktura Dna</label>
                        <i data-lucide="mountain" class="input-icon" style="width: 16px; top: 72%;"></i>
                        <select name="bottomType" class="algo-input" style="padding-left: 2.8rem;">
                            <option value="ANY">Dowolne / Zr贸偶nicowane</option>
                            <option value="HARD">Twarde (Piach, 呕wir, Kamienie)</option>
                            <option value="SOFT">Mikkie (Mu, Glina, Paskie blaty)</option>
                            <option value="VEGETATION">Zaronite (Trzciny, Podwodne ki)</option>
                        </select>
                    </div>
                    <div class="mt-4 pt-4 border-top" style="border-color: var(--glass-border);">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <label class="text-white fs-8 text-uppercase fw-bold mb-0">Szukana Gboko</label>
                            <span id="depthVal" class="text-brand-green fw-black font-monospace fs-6">0.5 - 5.0 m</span>
                        </div>
                        <input type="range" class="algo-range" min="0.5" max="20" step="0.5" id="depthSlider" name="targetDepth" value="5">
                        <small class="d-block mt-2 fs-8 text-muted">Dopasowuje odczyty do zachowa ryb w wybranej termoklinie.</small>
                    </div>
                </div>
            </div>

            <div class="col-xl-8 d-flex flex-column gap-4">

                <div class="algo-glass-panel p-3 p-md-4">
                    <div class="section-header justify-content-between mb-4">
                        <div class="d-flex align-items-center gap-2"><i data-lucide="target" class="text-brand-green"></i> 3. Gatunki (Cel Poowu)</div>
                    </div>

                    <div class="alert mb-4 py-3 px-3 d-flex gap-3 align-items-start border-0" style="background: rgba(0, 0, 0, 0.3); border-radius: 12px; box-shadow: inset 0 0 10px rgba(0,0,0,0.5);">
                        <i data-lucide="info" class="text-brand-green flex-shrink-0 mt-1"></i>
                        <div>
                            <strong class="text-white d-block mb-1">Informacja o wska藕niku:</strong>
                            <p class="mb-0 fs-7" style="color: var(--text-secondary);">Wyb贸r ryb uruchomi precyzyjne wagi biologiczne pod dany gatunek. <span class="text-white fw-bold">Niewybranie 偶adnego gatunku</span> wygeneruje og贸ln prognoz aktywnoci 偶erowej caego owiska.</p>
                        </div>
                    </div>

                    <div class="row g-4">
                        <div class="col-md-6">
                            <h6 class="fw-bold mb-3 d-flex align-items-center gap-2" style="color: var(--predator-red); text-transform: uppercase; font-size: 0.85rem; letter-spacing: 1px;">
                                <i data-lucide="swords" style="width:16px;"></i> Drapie偶niki
                            </h6>
                            <div class="fish-grid">
                                <label class="fish-card card-predator"><input type="checkbox" name="species" value="SZCZUPAK"><div><i data-lucide="scissors" style="transform: rotate(-45deg);"></i><span>Szczupak</span></div></label>
                                <label class="fish-card card-predator"><input type="checkbox" name="species" value="SANDACZ"><div><i data-lucide="moon"></i><span>Sandacz</span></div></label>
                                <label class="fish-card card-predator"><input type="checkbox" name="species" value="OKON"><div><i data-lucide="fish"></i><span>Oko</span></div></label>
                                <label class="fish-card card-predator"><input type="checkbox" name="species" value="SUM"><div><i data-lucide="anchor"></i><span>Sum</span></div></label>
                            </div>
                        </div>

                        <div class="col-md-6 border-start-md" style="border-color: rgba(255,255,255,0.05);">
                            <h6 class="fw-bold mb-3 d-flex align-items-center gap-2 ps-md-2" style="color: var(--brand-green); text-transform: uppercase; font-size: 0.85rem; letter-spacing: 1px;">
                                <i data-lucide="circle-dot" style="width:16px;"></i> Spokojny 呕er
                            </h6>
                            <div class="fish-grid ps-md-2">
                                <label class="fish-card card-whitefish"><input type="checkbox" name="species" value="KARP"><div><i data-lucide="circle"></i><span>Karp</span></div></label>
                                <label class="fish-card card-whitefish"><input type="checkbox" name="species" value="LESZCZ"><div><i data-lucide="database"></i><span>Leszcz</span></div></label>
                                <label class="fish-card card-whitefish"><input type="checkbox" name="species" value="LIN"><div><i data-lucide="droplets"></i><span>Lin</span></div></label>
                                <label class="fish-card card-whitefish"><input type="checkbox" name="species" value="AMUR"><div><i data-lucide="leaf"></i><span>Amur</span></div></label>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="algo-glass-panel p-3 p-md-4 flex-grow-1" style="border-top: 2px solid var(--brand-green);">
                    <div class="section-header"><i data-lucide="sliders" class="text-brand-green"></i> 4. Konfiguracja i Filtry</div>

                    <div class="row mb-5 g-4">
                        <div class="col-lg-6">
                            <h6 class="text-white fs-8 text-uppercase mb-3 ps-1" style="letter-spacing: 1px;">Moduy Aktywne</h6>
                            <div class="settings-grid" style="grid-template-columns: 1fr;">
                                <div class="algo-switch-wrapper">
                                    <input class="form-check-input algo-switch switch-module" type="checkbox" id="strictPressure" name="strictPressure" checked>
                                    <div>
                                        <div class="switch-title"><i data-lucide="gauge"></i> Rygor Cinieniowy</div>
                                        <div class="switch-desc">Uciana punkty przy nagych skokach barometru (>2hPa/3h).</div>
                                    </div>
                                </div>
                                <div class="algo-switch-wrapper">
                                    <input class="form-check-input algo-switch switch-module" type="checkbox" id="solunar" name="solunar" checked>
                                    <div>
                                        <div class="switch-title"><i data-lucide="moon-star"></i> Zota Godzina i Ksi偶yc</div>
                                        <div class="switch-desc">Uwzgldnia wschody/zachody soca i fazy ksi偶yca.</div>
                                    </div>
                                </div>
                                <div class="algo-switch-wrapper" style="border-color: rgba(46, 204, 113, 0.2); background: rgba(46, 204, 113, 0.05);">
                                    <input class="form-check-input algo-switch switch-module" type="checkbox" id="useVirtual" name="useVirtual" checked>
                                    <div>
                                        <div class="switch-title text-brand-green"><i data-lucide="cpu" class="text-brand-green"></i> Virtual Station AI</div>
                                        <div class="switch-desc">Wspomaga stacje IMGW modelami matematycznymi (Zalecane).</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-lg-6">
                            <h6 class="fs-8 text-uppercase mb-3 ps-1" style="color: var(--ignore-orange); letter-spacing: 1px;">Filtry Wykluczajce (Ignorancje)</h6>
                            <div class="settings-grid" style="grid-template-columns: 1fr;">
                                <div class="algo-switch-wrapper">
                                    <input class="form-check-input algo-switch switch-ignore" type="checkbox" id="ignoreHydro" name="ignoreHydro">
                                    <div>
                                        <div class="switch-title"><i data-lucide="waves"></i> Ignoruj IMGW Hydro</div>
                                        <div class="switch-desc">Odcina pomiary z rzek. Zaznacz, jeli owisz na zamknitym jeziorze.</div>
                                    </div>
                                </div>
                                <div class="algo-switch-wrapper">
                                    <input class="form-check-input algo-switch switch-ignore" type="checkbox" id="ignoreWind" name="ignoreWind">
                                    <div>
                                        <div class="switch-title"><i data-lucide="wind"></i> Ignoruj Porywy Wiatru</div>
                                        <div class="switch-desc">Znosi kary za silny wiatr (np. owisz w osonitej lenej zatoce).</div>
                                    </div>
                                </div>
                                <div class="algo-switch-wrapper">
                                    <input class="form-check-input algo-switch switch-ignore" type="checkbox" id="ignoreRain" name="ignoreRain">
                                    <div>
                                        <div class="switch-title"><i data-lucide="cloud-rain"></i> Ignoruj Ulewy (Opady)</div>
                                        <div class="switch-desc">Wycza kary punktowe za rzsisty deszcz dla twardych zawodnik贸w.</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <button type="submit" class="btn-launch">
                        <i data-lucide="radar" style="width: 24px;"></i> Uruchom Skanowanie Wody
                    </button>
                </div>

            </div>
        </div>
    </form>
</main>

<footer th:replace="~{fragments/footer :: footer}"></footer>

<script th:inline="javascript">
    document.addEventListener('DOMContentLoaded', () => {
        if (typeof lucide !== 'undefined') lucide.createIcons();

        const depthSlider = document.getElementById('depthSlider');
        const depthVal = document.getElementById('depthVal');
        if(depthSlider && depthVal) {
            depthSlider.addEventListener('input', (e) => {
                const val = parseFloat(e.target.value).toFixed(1);
                depthVal.innerText = val == 20 ? '> 20.0 m' : `0.5 - ${val} m`;
            });
        }

        const btnLocate = document.getElementById('btn-locate');
        const locationInput = document.getElementById('locationInput');
        const latInput = document.getElementById('latInput');
        const lonInput = document.getElementById('lonInput');

        if (btnLocate) {
            btnLocate.addEventListener('click', () => {
                if (!navigator.geolocation) { alert('Przegldarka nie wspiera GPS.'); return; }

                const originalHtml = btnLocate.innerHTML;
                btnLocate.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span> Pozycjonowanie...';
                btnLocate.disabled = true;

                navigator.geolocation.getCurrentPosition(async (position) => {
                        const lat = position.coords.latitude; const lon = position.coords.longitude;
                        latInput.value = lat; lonInput.value = lon;

                        try {
                            const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&zoom=10`);
                            const data = await response.json();
                            const city = data.address?.city || data.address?.town || data.address?.village || '';
                            locationInput.value = city ? ` ${city} (Zlokalizowano)` : ` ${lat.toFixed(4)}, ${lon.toFixed(4)}`;
                        } catch (e) { locationInput.value = ` ${lat.toFixed(4)}, ${lon.toFixed(4)}`; }

                        btnLocate.innerHTML = '<i data-lucide="check" class="me-2"></i> Pozycja Ustalona';
                        btnLocate.style.background = 'rgba(46, 204, 113, 0.2)';
                        btnLocate.style.color = '#fff';
                        btnLocate.style.borderColor = 'var(--brand-green)';
                        lucide.createIcons();
                        setTimeout(() => { btnLocate.disabled = false; btnLocate.innerHTML = originalHtml; btnLocate.style = ''; lucide.createIcons(); }, 3000);
                    },
                    () => { alert('Nie udao si pobra lokalizacji GPS.'); btnLocate.disabled = false; btnLocate.innerHTML = originalHtml; lucide.createIcons(); },
                    { enableHighAccuracy: true, timeout: 10000 }
                );
            });
        }

        const algoForm = document.getElementById('algoForm');
        const loader = document.getElementById('fishing-loader');
        const loaderDesc = document.getElementById('loading-desc');
        const loadingBar = document.getElementById('loading-bar');
        const loadingHook = document.getElementById('loading-hook');
        const fishElements = [document.getElementById('lf1'), document.getElementById('lf2'), document.getElementById('lf3')];

        const logTexts = [
            "Pobieranie mapy batymetrycznej akwenu...",
            "Weryfikacja stacji IMGW Synop & Hydro...",
            "Skanowanie stref przydennych i termokliny...",
            "Aplikowanie rygoru cinieniowego...",
            "Aplikowanie filtr贸w i wyklucze pogodowych...",
            "Rozliczanie faz ksi偶yca i zotej godziny...",
            "Generowanie wektor贸w i prognozy bra..."
        ];

        algoForm.addEventListener('submit', (e) => {
            e.preventDefault();
            window.scrollTo(0,0); document.body.style.overflow = 'hidden';
            loader.classList.add('active');

            let progress = 0;
            let textIndex = 0;

            const progressInt = setInterval(() => {
                progress += Math.random() * 8 + 2;
                if(progress > 100) progress = 100;
                loadingBar.style.width = `${progress}%`;
                loadingHook.style.left = `calc(${progress}% - 8px)`;

                const expectedIndex = Math.floor((progress / 100) * logTexts.length);
                if(expectedIndex > textIndex && expectedIndex < logTexts.length) {
                    textIndex = expectedIndex;
                    loaderDesc.innerText = logTexts[textIndex];
                }
            }, 300);

            setInterval(() => {
                fishElements.forEach(f => {
                    const rect = f.getBoundingClientRect();
                    const screenWidth = window.innerWidth;
                    if(rect.left > screenWidth*0.35 && rect.right < screenWidth*0.65) {
                        f.classList.add('active');
                    } else {
                        f.classList.remove('active');
                    }
                });
            }, 200);

            setTimeout(() => {
                clearInterval(progressInt);
                loadingBar.style.width = '100%';
                loadingHook.style.left = 'calc(100% - 8px)';
                loaderDesc.innerText = "ZAKOCZONO SKANOWANIE. GENEROWANIE RAPORTU...";
                loaderDesc.style.color = "var(--brand-green)";
                loaderDesc.style.fontWeight = "bold";

                setTimeout(() => { algoForm.submit(); }, 600);
            }, 4500);
        });
    });
</script>
</body>
</html>