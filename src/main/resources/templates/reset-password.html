<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="pl">
<head>
    <th:block th:replace="~{fragments/head :: head-content(
        pageTitle='Nowe hasło | CzyZlowie',
        pageDescription='Wpisz nowe, bezpieczne hasło do swojego konta wędkarskiego.'
    )}"></th:block>

    <link rel="stylesheet" th:href="@{/css/main.css}">
    <link rel="stylesheet" th:href="@{/css/auth.css}">
    <script src="https://unpkg.com/lucide@latest" defer></script>
</head>
<body class="auth-page">

<nav th:replace="~{fragments/navbar :: navbar}"></nav>

<main class="auth-wrapper">
    <picture class="auth-bg-picture">
        <source media="(max-width: 768px)" srcset="/assets/ryby/predators-bg.jpg">
        <img src="/assets/ryby/predators-bg.jpg" alt="Mroczne dno jeziora" class="auth-bg-image">
    </picture>
    <div class="auth-bg-overlay"></div>

    <div class="container-xl d-flex justify-content-center align-items-center min-vh-100 py-5 position-relative z-2" style="margin-top: 30px;">

        <div class="auth-card glass-panel w-100" style="max-width: 950px;">
            <div class="row g-0 align-items-center">

                <div class="col-lg-6 auth-form-section pe-lg-5 py-lg-4">

                    <div class="text-center text-lg-start mb-4">
                        <a th:href="@{/}">
                            <img src="/assets/logo.png" alt="CzyZlowie Logo" class="auth-logo mb-4">
                        </a>
                        <h1 class="auth-title" style="font-size: 1.8rem;">Ostatni krok!</h1>
                        <p class="auth-subtitle">Wpisz nowe hasło poniżej, aby odzyskać dostęp do swojego konta.</p>
                    </div>

                    <div th:if="${param.error}" class="alert auth-alert alert-danger d-flex align-items-center gap-2">
                        <i data-lucide="shield-alert" style="width: 20px;"></i>
                        <span>Twój link wygasł lub jest nieprawidłowy. <a th:href="@{/zapomnialem-hasla}" class="text-danger fw-bold text-decoration-underline">Spróbuj ponownie.</a></span>
                    </div>

                    <div th:if="${param.success}" class="alert auth-alert alert-success d-flex align-items-start gap-2">
                        <i data-lucide="check-circle" style="width: 24px; margin-top: 2px; flex-shrink:0;"></i>
                        <div>
                            <strong>Udało się!</strong><br>
                            <span class="fs-7">Twoje hasło zostało zmienione. Możesz się teraz bezpiecznie zalogować.</span>
                        </div>
                    </div>

                    <form th:unless="${param.success}" th:action="@{/reset-hasla}" method="post" class="auth-form mt-4" id="resetPasswordForm">

                        <input type="hidden" name="token" th:value="${token}">

                        <div class="form-group mb-3">
                            <label for="password" class="form-label text-white-50 fs-7 fw-bold text-uppercase mb-2">Nowe hasło</label>
                            <div class="input-icon-wrapper">
                                <i data-lucide="lock" class="input-icon"></i>
                                <input type="password" id="password" name="password" class="form-control auth-input password-input" placeholder="Wpisz nowe hasło" required minlength="8">
                                <button type="button" class="btn-toggle-pass" aria-label="Pokaż hasło">
                                    <i data-lucide="eye" style="width: 18px;"></i>
                                </button>
                            </div>
                        </div>

                        <div class="form-group mb-4">
                            <label for="confirmPassword" class="form-label text-white-50 fs-7 fw-bold text-uppercase mb-2">Powtórz nowe hasło</label>
                            <div class="input-icon-wrapper">
                                <i data-lucide="check-square" class="input-icon" id="matchIcon"></i>
                                <input type="password" id="confirmPassword" name="confirmPassword" class="form-control auth-input password-input" placeholder="Potwierdź nowe hasło" required minlength="8">
                                <button type="button" class="btn-toggle-pass" aria-label="Pokaż hasło">
                                    <i data-lucide="eye" style="width: 18px;"></i>
                                </button>
                            </div>
                            <div id="passwordMatchMessage" class="fs-7 mt-2 d-none">Hasła nie są identyczne!</div>
                        </div>

                        <button type="submit" id="submitBtn" class="btn btn-auth-primary w-100 position-relative overflow-hidden">
                            <span class="position-relative z-1 d-flex align-items-center justify-content-center">
                                ZAPISZ NOWE HASŁO <i data-lucide="save" class="ms-2" style="width: 18px;"></i>
                            </span>
                            <div class="btn-shine"></div>
                        </button>
                    </form>

                    <div th:if="${param.success}" class="mt-4">
                        <a th:href="@{/login}" class="btn btn-auth-primary w-100 position-relative overflow-hidden text-decoration-none">
                            <span class="position-relative z-1 d-flex align-items-center justify-content-center">
                                PRZEJDŹ DO LOGOWANIA <i data-lucide="arrow-right" class="ms-2" style="width: 18px;"></i>
                            </span>
                        </a>
                    </div>
                </div>

                <div class="col-auto d-none d-lg-flex flex-column align-items-center justify-content-center px-4">
                    <div class="auth-divider-line" style="height: 100px;"></div>
                </div>

                <div class="col-12 d-lg-none my-4 position-relative text-center">
                    <hr class="auth-divider-mobile">
                </div>

                <div class="col-lg ps-lg-4 d-flex flex-column justify-content-center">

                    <div class="d-flex align-items-start gap-3 mb-4">
                        <div class="icon-pulse" style="background: rgba(46, 204, 113, 0.2); box-shadow: 0 0 0 0 rgba(46, 204, 113, 0.4); animation: pulseGreen 2s infinite;">
                            <i data-lucide="shield-check" class="text-brand-green"></i>
                        </div>
                        <div>
                            <h4 class="text-white fw-bold mb-1 fs-5">Bezpieczna przystań</h4>
                            <p class="text-muted-pro fs-7 mb-0">Zadbaj o to, aby Twoje nowe hasło było silne jak plecionka na suma.</p>
                        </div>
                    </div>

                    <ul class="auth-benefits-list mt-3">
                        <li>
                            <i data-lucide="check" class="text-brand-green"></i>
                            <span>Minimum <strong>8 znaków</strong> długości.</span>
                        </li>
                        <li>
                            <i data-lucide="check" class="text-brand-green"></i>
                            <span>Przynajmniej jedna <strong>wielka litera</strong>.</span>
                        </li>
                        <li>
                            <i data-lucide="check" class="text-brand-green"></i>
                            <span>Przynajmniej jedna <strong>cyfra</strong> (np. 1, 2, 3).</span>
                        </li>
                        <li>
                            <i data-lucide="check" class="text-brand-green"></i>
                            <span>Nie używaj starych, łatwych do odgadnięcia haseł.</span>
                        </li>
                    </ul>

                </div>

            </div>
        </div>
    </div>
</main>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        lucide.createIcons();

        const toggleButtons = document.querySelectorAll('.btn-toggle-pass');
        toggleButtons.forEach(btn => {
            btn.addEventListener('click', function() {
                const input = this.previousElementSibling;
                const type = input.getAttribute('type') === 'password' ? 'text' : 'password';
                input.setAttribute('type', type);

                const icon = this.querySelector('i');
                if(type === 'text') {
                    icon.setAttribute('data-lucide', 'eye-off');
                } else {
                    icon.setAttribute('data-lucide', 'eye');
                }
                lucide.createIcons();
            });
        });

        const pass1 = document.getElementById('password');
        const pass2 = document.getElementById('confirmPassword');
        const msg = document.getElementById('passwordMatchMessage');
        const matchIcon = document.getElementById('matchIcon');
        const submitBtn = document.getElementById('submitBtn');

        function checkPasswords() {
            if (pass2.value === "") {
                msg.classList.add('d-none');
                matchIcon.style.color = '#94a3b8';
                submitBtn.disabled = false;
                return;
            }

            if (pass1.value !== pass2.value) {
                msg.textContent = "Hasła nie są identyczne!";
                msg.classList.remove('d-none');
                msg.classList.add('text-danger');
                msg.classList.remove('text-success');
                matchIcon.style.color = '#ef4444';
                submitBtn.disabled = true;
            } else {
                msg.textContent = "Hasła pasują do siebie!";
                msg.classList.remove('d-none');
                msg.classList.remove('text-danger');
                msg.classList.add('text-success');
                matchIcon.style.color = '#2ecc71';
                submitBtn.disabled = false;
            }
        }

        if(pass1 && pass2) {
            pass1.addEventListener('input', checkPasswords);
            pass2.addEventListener('input', checkPasswords);
        }
    });
</script>
</body>
</html>